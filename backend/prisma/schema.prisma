generator client {
  provider = "prisma-client"
  output   = "../src/config/prisma/generated"
  moduleFormat  = "esm"
}

datasource db {
  provider = "postgresql"
}

//////////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////////

enum site_status {
  active
  inactive
  maintenance
  decommissioned
}

enum compliance_status {
  within_limit
  limit_exceeded
  unknown
}

enum emission_unit {
  kg
  tonne
  scf
  ppm
}

enum error_severity {
  low
  medium
  high
  critical
}

//////////////////////////////////////////////////////
// CORE SITE MODEL
//////////////////////////////////////////////////////

model site {
  id                        Int               @id @default(autoincrement())
  site_name                 String
  site_type                 String
  status                    site_status       @default(active)
  latitude                  Decimal?          @db.Decimal(10, 7)
  longitude                 Decimal?          @db.Decimal(10, 7)
  emission_limit            Decimal           @db.Decimal(18, 6)
  total_emissions_to_date   Decimal           @default(0) @db.Decimal(18, 6)
  metadata                  Json?
  last_measurement_at       DateTime?
  rolling_24h_emissions     Decimal?          @db.Decimal(18, 6)
  rolling_30d_emissions     Decimal?          @db.Decimal(18, 6)
  measurements              measurement[]
  ingestion_batches         ingestion_batch[]
  current_compliance_status compliance_status @default(unknown)
  created_at                DateTime          @default(now())
  updated_at                DateTime          @updatedAt
  deleted_at                DateTime?
  error_logs                error_log[]

  @@map("site")
}

//////////////////////////////////////////////////////
// MEASUREMENTS (RAW TELEMETRY â€” NEVER DELETE)
//////////////////////////////////////////////////////

model measurement {
  id             Int              @id @default(autoincrement())
  site_id        Int
  site           site             @relation(fields: [site_id], references: [id], onDelete: Cascade)
  batch_id       Int?
  batch          ingestion_batch? @relation(fields: [batch_id], references: [id])
  measured_at    DateTime
  emission_value Decimal          @db.Decimal(18, 6)
  unit           emission_unit
  raw_payload    Json?
  created_at     DateTime         @default(now())

  @@index([site_id])
  @@index([measured_at])
  @@map("measurement")
}

//////////////////////////////////////////////////////
// IDEMPOTENT INGESTION (CRITICAL FOR FIELD DEVICES)
//////////////////////////////////////////////////////

model ingestion_batch {
  id              Int           @id @default(autoincrement())
  site_id         Int
  site            site          @relation(fields: [site_id], references: [id], onDelete: Cascade)
  client_batch_id String        @unique
  received_at     DateTime      @default(now())
  processed       Boolean       @default(false)
  measurements    measurement[]
  created_at      DateTime      @default(now())

  @@index([site_id])
  @@map("ingestion_batch")
}

//////////////////////////////////////////////////////
// ENTERPRISE ERROR OBSERVABILITY
//////////////////////////////////////////////////////

model error_log {
  id         Int            @id @default(autoincrement())
  service    String?
  endpoint   String?
  request_id String?
  error_code String
  message    String
  severity   error_severity @default(medium)
  context    Json?
  site_id    Int?
  site       site?          @relation(fields: [site_id], references: [id])
  created_at DateTime       @default(now())

  @@index([request_id])
  @@index([site_id])
  @@map("error_log")
}
